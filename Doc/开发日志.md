# PetitionLetter 系统开发日志

## 1. Extraction 阶段优化 - 律师框架引入

**日期**: 2026-02-17

### 1.1 问题背景

系统原有的 Extraction 流程能够从 Exhibit 文档中提取证据片段(snippets)，但存在以下问题：

1. **只提取直接证据**: 只关注"申请人做了什么"，忽略了"为什么这很重要"
2. **缺少证据分层**: 没有区分 Claim(声明)、Proof(证明)、Significance(重要性)、Context(背景)
3. **论点碎片化**: 生成的论点过于分散，一个标准可能有20+个独立论点

### 1.2 律师视角分析

参考例文 `Yaruo Qu PetitionLetter.md`，专业移民律师的论证结构为：

```
每个 EB-1A 标准 = 1-3 个核心论点
每个论点 = Claim + Proof + Significance + Context + Conclusion
```

**关键发现**: USCIS 审查时最关注的是 **Significance 层**，即：
- Membership: 其他杰出会员是谁？(证明选择性)
- Published Material: 媒体发行量多少？获过什么奖？(证明是"major media")
- Original Contribution: 量化影响是什么？(证明"major significance")
- Leading Role: 组织有什么声誉？(证明"distinguished reputation")

### 1.3 优化方案

#### 阶段一：增强 Extraction (已完成)

**新增文件**:
- `evidence_requirements.py`: 律师框架的证据需求清单
- `evidence_checker.py`: 证据完整性检查器
- `argument_organizer.py`: 论点组织器

**修改文件**:
- `unified_extractor.py`:
  - 新增 `evidence_purpose` 字段: direct_proof / selectivity_proof / credibility_proof / impact_proof
  - 新增 `evidence_layer` 字段: claim / proof / significance / context
  - 增强 System Prompt，添加 SIGNIFICANCE 层提取模式

**优化效果**:
| 指标 | 优化前 | 优化后 |
|------|--------|--------|
| Snippets | 154 | 178 |
| Significance层占比 | ~2% | 42% |
| Arguments | 35 | 55 |

#### 阶段二：论点组合 (进行中)

**问题**: 虽然现在能提取 Significance 层证据，但论点仍然碎片化：
- Membership: 9个论点 (例文: 1个)
- Original Contribution: 21个论点 (例文: 1个)

**解决方案**: 新增 `argument_composer.py`

**分组规则**:
| 标准 | 分组键 | 目标 |
|------|--------|------|
| Membership | 协会名称 | 1个协会 = 1个论点 |
| Published Material | 媒体名称 | 1个媒体 = 1个论点 |
| Original Contribution | 不分组 | 所有证据 = 1个整体论点 |
| Leading Role | 组织名称 | 1个组织 = 1个论点 |
| Awards | 奖项名称 | 1个奖项 = 1个论点 |

**输出结构**:
```json
{
  "title": "Ms. Qu's Membership in Shanghai Fitness Bodybuilding Association",
  "standard": "membership",
  "claim": [...],
  "proof": [...],
  "significance": [...],
  "context": [...],
  "exhibits": ["C-1", "C-2", "C-6"],
  "conclusion": "clearly meets 8 C.F.R. §204.5(h)(3)(ii)",
  "completeness": {"has_significance": true, "score": 100}
}
```

### 1.4 架构图

```
┌──────────────────────────────────────────────────────────────┐
│                     PetitionLetter 系统                       │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  Exhibits (PDF)                                              │
│       │                                                      │
│       ▼                                                      │
│  ┌─────────────────────┐                                     │
│  │ unified_extractor   │  ← 增强: evidence_layer,            │
│  │                     │         evidence_purpose            │
│  └──────────┬──────────┘                                     │
│             │                                                │
│             ▼                                                │
│  ┌─────────────────────┐                                     │
│  │ Snippets (178个)    │  包含: claim/proof/significance     │
│  └──────────┬──────────┘                                     │
│             │                                                │
│             ▼                                                │
│  ┌─────────────────────┐     ┌─────────────────────┐        │
│  │ argument_generator  │ ──► │ argument_composer   │ [新增]  │
│  │ (碎片化论点)         │     │ (结构化论点)         │        │
│  └─────────────────────┘     └──────────┬──────────┘        │
│                                         │                    │
│             ┌───────────────────────────┘                    │
│             ▼                                                │
│  ┌─────────────────────┐     ┌─────────────────────┐        │
│  │ evidence_checker    │     │ Lawyer-style Output │        │
│  │ (完整性检查)         │     │ (Markdown/PDF)      │        │
│  └─────────────────────┘     └─────────────────────┘        │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

### 1.5 文件清单

| 文件 | 功能 | 状态 |
|------|------|------|
| `unified_extractor.py` | 统一提取器 | 已优化 |
| `evidence_requirements.py` | 证据需求清单 | 新增 |
| `evidence_checker.py` | 完整性检查器 | 新增 |
| `argument_organizer.py` | 论点组织器 (基础版) | 新增 |
| `argument_composer.py` | 论点组合器 (律师版) | 已完成 |

---

## 2. Human-in-the-Loop 审核功能

**日期**: 2026-02-17

### 2.1 问题背景

作为 HCI 项目，系统需要在自动化流程中引入人类参与环节，让用户可以：
- 审核 AI 生成的论点
- 决定保留/排除哪些论点
- 查看每个论点的完整性检查结果

### 2.2 设计方案

基于现有的四栏界面（DocumentViewer | EvidenceCardPool | ArgumentAssembly | StandardsPanel），
在 **ArgumentAssembly** 面板中添加审核模式：

```
┌────────────────────────────────────────────────────┐
│  Argument Assembly              [Review] [Generate] │
├────────────────────────────────────────────────────┤
│  ✓ 5 approved  ✗ 3 excluded  ○ 2 pending           │
├────────────────────────────────────────────────────┤
│  ┌─ AI: Recommend Keep ────────────────────────┐   │
│  │ Shanghai Fitness Bodybuilding Association    │   │
│  │ ✓ Has membership certificate                 │   │
│  │ ✓ Has membership criteria                    │   │
│  │ ✗ Has selectivity proof                      │   │
│  │ Completeness: ████████░░ 66%                 │   │
│  │ [✅ Keep] [❌ Exclude]                        │   │
│  └──────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────┘
```

### 2.3 实现内容

#### 前端 (React/TypeScript)

**修改文件**: `types/index.ts`
- 新增 `QualificationCheck` 接口
- 新增 `ArgumentQualification` 接口
- 新增 `HumanDecision` 类型
- 修改 `Argument` 接口，添加 `qualification` 和 `humanDecision` 字段

**修改文件**: `components/ArgumentAssembly.tsx`
- 新增 `QualificationPanel` 组件，显示资格检查结果
- 新增 `reviewMode` 状态切换
- 添加审核统计显示（approved/excluded/pending）
- 添加 Keep/Exclude 决策按钮

#### 后端 (Python/FastAPI)

**新增文件**: `services/argument_qualifier.py`
- 定义各标准的资格检查规则
- 实现 `qualify_argument()` 函数
- 实现 `qualify_all_arguments()` 函数
- 实现 `get_qualification_summary()` 函数

**修改文件**: `routers/arguments.py`
- 修改 `GET /api/arguments/{project_id}` 端点
- 添加 `include_qualification` 参数

**修改文件**: `services/argument_generator.py`
- 添加 `load_snippets()` 方法

### 2.4 资格检查规则

| 标准 | 检查项 | 类型 |
|------|--------|------|
| **Membership** | 有会员证书 | Required |
| | 有入会标准 | Required |
| | 有选择性证明 (杰出会员) | Required |
| **Published Material** | 有关于申请人的报道 | Required |
| | 有媒体资质证明 | Required |
| **Original Contribution** | 有原创贡献描述 | Required |
| | 有影响力证明 | Required |
| | 有专家认可 | Optional |
| **Leading Role** | 有领导角色证据 | Required |
| | 有组织声誉证明 | Required |
| **Awards** | 有奖项证据 | Required |
| | 有国家/国际认可 | Required |
| | 有选择性证明 | Optional |

### 2.5 测试结果

对 55 个论点进行资格检查：
- **Keep**: 29 (53%)
- **Exclude**: 26 (47%)
- **Avg Completeness**: 38.2%

按标准分布：
| 标准 | Keep | Exclude |
|------|------|---------|
| original_contribution | 13 | 8 |
| published_material | 10 | 6 |
| leading_role | 3 | 4 |
| membership | 1 | 8 |
| awards | 1 | 0 |

### 2.6 下一步

1. 前端调用 API 获取 qualification 数据
2. 测试完整的审核流程
3. 添加合并论点功能

---

*日志由开发团队维护*
